"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"SOURCE",scaleDomain:null,scaleRange:[1,5],onMouseEnterNode:null,onMouseLeaveNode:null,onMouseEnterLine:null,onMouseLeaveLine:null},_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_linearScale:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var e=this,n=this.options.data.map(function(t){return delete t.connections[t.properties.id],t});this._targetId=null;var o;if(this.options.scaleDomain)o=this.options.scaleDomain;else{var i=[];n.forEach(function(t){i=i.concat(Object.values(t.connections))});var s=d3.min(i),a=d3.max(i);o=[s,a]}this._linearScale=d3.scaleLinear().domain(o).range(this.options.scaleRange),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var r=d3.select("#"+t.getContainer().id).select("svg");r.attr("pointer-events","all"),this._svgGroup1=r.append("g"),this._svgGroup2=this._svgGroup1.append("g"),n.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(n.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",.5).style("cursor","pointer").style("fill","red").attr("r",5).on("click",function(t){console.log(t),e._svgGroup1.selectAll("circle").style("opacity",.5).attr("r",5),d3.select(this).style("opacity","0.8").attr("r",10),e._targetId=t.properties.id,e._drawConnections(e._targetId)}).on("mouseenter",this.options.onMouseEnterNode).on("mouseleave",this.options.onMouseLeaveNode),this._map=t,this._map.on("moveend viewreset",this.update,this),this.update()},onRemove:function(t){this._mapSvg.removeFrom(t)},update:function(){var t=this;t._svgGroup1.selectAll("circle").style("opacity",.5).attr("r",5),t._drawConnections(this._targetId),this._svgGroup1.selectAll("circle").attr("transform",function(e){return"translate("+t._map.latLngToLayerPoint(e.properties.LatLng).x+","+t._map.latLngToLayerPoint(e.properties.LatLng).y+")"})},setData:function(t){this.options.data=t,this.update()},setTarget:function(t){this._targetId=t,this.update()},setDisplayMode:function(t){this.options.displayMode=t,this.update()},getPointById:function(t){for(var e=this.options.data,n=0;n<e.length;n++)if(t==e[n].properties.id)return e[n]},_drawConnections:function(t){var e=this,n=this._map,o=this.options.data,i=this._svgGroup2;i.selectAll(".connection").remove(),o.forEach(function(o){var s=n.latLngToLayerPoint(o.properties.LatLng),a=Object.keys(o.connections);a.forEach(function(a){var r=e.getPointById(a);if(r&&o.connections[a]){var l=n.latLngToLayerPoint(r.properties.LatLng),p=o.connections[a],c=parseInt(e._linearScale(p)),d="grey",u=.2;t&&("SOURCE"==e.options.displayMode&&t==o.properties.id?(d="red",u=.8):"SINK"==e.options.displayMode&&t==a?(d="green",u=.8):"ANY"==e.options.displayMode?(t==o.properties.id&&(d="red",u=.8),t==a&&(d="red",u=.8)):"BOTH"==e.options.displayMode&&(t==o.properties.id&&(d="red",u=.8),t==a&&(d="green",u=.8))),i.append("line").attr("class","connection").attr("x1",s.x).attr("y1",s.y).attr("x2",l.x).attr("y2",l.y).attr("stroke-width",c).attr("stroke-opacity",u).attr("stroke",d)}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};