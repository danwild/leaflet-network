"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"ANY",weightMode:"NONE",colorScale:["#7EC891","#FE5E69"],sourceColor:"#FE5E69",sinkColor:"#7EC891",allColor:"purple",lineInactiveColor:"grey",globalScaleDomain:null,nodeFillColor:"red",nodeOpacity:.5,nodeRadius:5,lineOpacity:.8,lineWidth:2,lineWidthActive:2,lineDashStyle:"20, 3",clipRange:null,onClickNode:null,onMouseEnterNode:null,onMouseLeaveNode:null,onMouseEnterLine:null,onMouseLeaveLine:null},_active:!1,_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_colors:[],_globalColorScale:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var o=this;this._active=!0;var e=this.options.data.map(function(t){return delete t.connections[t.properties.id],t});this._targetId=null,this._updateGlobalScale(),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var n=d3.select("#"+t.getContainer().id).select("svg");n.attr("pointer-events","all"),this._svgGroup1=n.append("g"),this._svgGroup2=this._svgGroup1.append("g"),e.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(e.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",o.options.nodeOpacity).style("cursor","pointer").style("fill",o.options.nodeFillColor).attr("r",o.options.nodeRadius).on("click",function(t){"GLOBAL"!==o.options.weightMode&&(console.log(t),o._svgGroup1.selectAll("circle").style("opacity",o.options.nodeOpacity).attr("r",5),d3.select(this).style("opacity","1").attr("r",10),o._targetId=t.properties.id,o._drawConnections(o._targetId)),o.options.onClickNode&&o.options.onClickNode(t)}).on("mouseenter",this.options.onMouseEnterNode).on("mouseleave",this.options.onMouseLeaveNode),this._map=t,this._map.on("moveend viewreset",this.update,this),this.update()},onRemove:function(t){this._active=!1,this._mapSvg.removeFrom(t)},update:function(){if(this.isActive()){var t=this;this._updateGlobalScale(),t._drawConnections(this._targetId),this._targetId&&"GLOBAL"!==this.options.weightMode||t._svgGroup1.selectAll("circle").style("opacity",t.options.nodeOpacity).attr("r",t.options.nodeRadius),this._svgGroup1.selectAll("circle").attr("transform",function(o){return"translate("+t._map.latLngToLayerPoint(o.properties.LatLng).x+","+t._map.latLngToLayerPoint(o.properties.LatLng).y+")"})}},getLatLngBounds:function(){return this.options.data&&this._map?L.latLngBounds(this.options.data.map(function(t){return[t.properties.lat,t.properties.lon]})):null},setData:function(t){this.options.data=t,this._active&&this.update()},setOptions:function(t){L.setOptions(this,t),this._active&&this.update()},setTarget:function(t){this._targetId=t,this._active&&this.update()},getTargetId:function(){return this._targetId},setDisplayMode:function(t){this.options.displayMode=t,this._active&&this.update()},getPointById:function(t){for(var o=this.options.data,e=0;e<o.length;e++)if(t==o[e].properties.id)return o[e]},isActive:function(){return this._active},getConnectionsDomain:function(t,o){var e=this;o||(o=this.options.data);var n=[];o.forEach(function(o){Object.values(o.connections).forEach(function(o){!e._connectionInRange(o)&&t||n.push(o)})});var i=d3.min(n),a=d3.max(n);return[i,a]},_updateGlobalScale:function(){var t=this;this.options.globalScaleDomain||(this.options.globalScaleDomain=this.getConnectionsDomain(!0,this.options.data),this.options.globalScaleDomain[1]=.9*this.options.globalScaleDomain[1]),this.options.colorScale.forEach(function(o){t._colors.push(d3.rgb(o))}),this._globalColorScale=d3.scaleLinear().domain(this.options.globalScaleDomain).interpolate(d3.interpolateRgb).range(this._colors)},_drawConnections:function(t){var o=this,e=this._map,n=this.options.data,i=this._svgGroup2;i.selectAll(".connection").remove();var a=[],s=[];if(n.forEach(function(n){var r=Object.keys(n.connections);r.forEach(function(r){var l=o.getPointById(r);if(l&&n.connections[r]){var p=o.options.lineInactiveColor,c=.2,d=n.connections[r],u=o._connectionInRange(d);if(t&&u&&"LOCAL"===o.options.weightMode){if(t===n.properties.id){var h={properties:n.properties,connections:{}};return h.connections[r]=n.connections[r],void a.push(h)}if(t===r){var g={properties:n.properties,connections:{}};return g.connections[r]=n.connections[r],void s.push(g)}}else if("GLOBAL"===o.options.weightMode&&u)p=o._globalColorScale(d),c=o.options.lineOpacity;else{if("GLOBAL"===o.options.weightMode&&!u)return;t&&"NONE"===o.options.weightMode&&u&&("SOURCE"==o.options.displayMode&&t==n.properties.id?(p=o.options.sourceColor,c=o.options.lineOpacity):"SINK"==o.options.displayMode&&t==r?(p=o.options.sinkColor,c=o.options.lineOpacity):"ANY"==o.options.displayMode?t!=n.properties.id&&t!=r||(p=o.options.allColor,c=o.options.lineOpacity):"BOTH"==o.options.displayMode&&(t==n.properties.id&&(p=o.options.sourceColor,c=o.options.lineOpacity),t==r&&(p=o.options.sinkColor,c=o.options.lineOpacity)))}var L=e.latLngToLayerPoint(n.properties.LatLng),v=e.latLngToLayerPoint(l.properties.LatLng);"NONE"!==o.options.weightMode&&p!==o.options.lineInactiveColor?i.append("line").attr("class","connection").attr("x1",L.x).attr("y1",L.y).attr("x2",v.x).attr("y2",v.y).attr("stroke-width",o.options.lineWidthActive).attr("stroke-opacity",c).attr("stroke",p).attr("data-weight",d).attr("data-lat",l.properties.LatLng.lat).attr("data-lon",l.properties.LatLng.lng).on("mouseenter",function(){o.options.onMouseEnterLine&&o.options.onMouseEnterLine(this)}).on("mouseleave",function(){o.options.onMouseLeaveLine&&o.options.onMouseLeaveLine(this)}):i.append("line").attr("class","connection").attr("x1",L.x).attr("y1",L.y).attr("x2",v.x).attr("y2",v.y).attr("stroke-width",2).attr("stroke-opacity",c).attr("stroke",p)}})}),"BOTH"===o.options.displayMode){var r=this.getConnectionsDomain(!0,s),l=d3.scaleLinear().domain(r).interpolate(d3.interpolateRgb).range(o._colors);this._drawLocalWeightedNodes(s,l,i,o.options.lineDashStyle);var p=this.getConnectionsDomain(!0,a),c=d3.scaleLinear().domain(p).interpolate(d3.interpolateRgb).range(o._colors);this._drawLocalWeightedNodes(a,c,i,null)}else{var d;switch(o.options.displayMode){case"SINK":d=s;break;case"SOURCE":d=a;break;case"ANY":d=s.concat(a);break;default:console.error("Invalid displayMode")}var u=this.getConnectionsDomain(!0,d),h=d3.scaleLinear().domain(u).interpolate(d3.interpolateHcl).range(o._colors);this._drawLocalWeightedNodes(d,h,i,null)}},_connectionInRange:function(t){return!this.options.clipRange||+t>=this.options.clipRange[0]&&+t<=this.options.clipRange[1]},_drawLocalWeightedNodes:function(t,o,e,n){var i=this;t.forEach(function(t){var a=Object.keys(t.connections);a.forEach(function(a){var s=i.getPointById(a);if(s&&t.connections[a]){var r=t.connections[a],l=i._map.latLngToLayerPoint(t.properties.LatLng),p=i._map.latLngToLayerPoint(s.properties.LatLng);e.append("line").attr("class","connection").attr("x1",l.x).attr("y1",l.y).attr("x2",p.x).attr("y2",p.y).attr("stroke-width",i.options.lineWidthActive).attr("stroke-opacity",i.options.lineOpacity).attr("stroke",o(r)).attr("data-weight",r).attr("data-lat",s.properties.LatLng.lat).attr("data-lon",s.properties.LatLng.lng).style("cursor","pointer").style("stroke-dasharray",n).on("mouseenter",function(){i.options.onMouseEnterLine&&i.options.onMouseEnterLine(this)}).on("mouseleave",function(){i.options.onMouseLeaveLine&&i.options.onMouseLeaveLine(this)})}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};