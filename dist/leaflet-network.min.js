"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"ANY",weightMode:"NONE",colorScale:["#7EC891","#FE5E69"],sourceColor:"#FE5E69",sinkColor:"#7EC891",allColor:"purple",globalScaleDomain:null,nodeFillColor:"red",nodeOpacity:.5,nodeRadius:5,lineOpacity:.8,lineWidth:2,lineWidthActive:2,lineDashStyle:"20, 3",onClickNode:null,onMouseEnterNode:null,onMouseLeaveNode:null,onMouseEnterLine:null,onMouseLeaveLine:null},_active:!1,_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_colors:[],_globalColorScale:null,initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var o=this,e=this;this._active=!0;var n=this.options.data.map(function(t){return delete t.connections[t.properties.id],t});this._targetId=null,this.options.globalScaleDomain||(this.options.globalScaleDomain=this._getConnectionsDomain(n),this.options.globalScaleDomain[1]=.9*this.options.globalScaleDomain[1]),this.options.colorScale.forEach(function(t){o._colors.push(d3.rgb(t))}),this._globalColorScale=d3.scaleLinear().domain(this.options.globalScaleDomain).interpolate(d3.interpolateRgb).range(e._colors),console.log("this.options.globalScaleDomain: "+this.options.globalScaleDomain),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var i=d3.select("#"+t.getContainer().id).select("svg");i.attr("pointer-events","all"),this._svgGroup1=i.append("g"),this._svgGroup2=this._svgGroup1.append("g"),n.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(n.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",e.options.nodeOpacity).style("cursor","pointer").style("fill",e.options.nodeFillColor).attr("r",e.options.nodeRadius).on("click",function(t){"GLOBAL"!==e.options.weightMode&&(console.log(t),e._svgGroup1.selectAll("circle").style("opacity",e.options.nodeOpacity).attr("r",5),d3.select(this).style("opacity","1").attr("r",10),e._targetId=t.properties.id,e._drawConnections(e._targetId)),e.options.onClickNode&&e.options.onClickNode(t)}).on("mouseenter",this.options.onMouseEnterNode).on("mouseleave",this.options.onMouseLeaveNode),this._map=t,this._map.on("moveend viewreset",this.update,this),this.update()},onRemove:function(t){this._active=!1,this._mapSvg.removeFrom(t)},update:function(){console.log("update");var t=this;t._drawConnections(this._targetId),this._targetId||t._svgGroup1.selectAll("circle").style("opacity",t.options.nodeOpacity).attr("r",t.options.nodeRadius),this._svgGroup1.selectAll("circle").attr("transform",function(o){return"translate("+t._map.latLngToLayerPoint(o.properties.LatLng).x+","+t._map.latLngToLayerPoint(o.properties.LatLng).y+")"})},setData:function(t){this.options.data=t,this._active&&this.update()},setOptions:function(t){L.setOptions(this,t),this._active&&this.update()},setTarget:function(t){this._targetId=t,this._active&&this.update()},getTargetId:function(){return this._targetId},setDisplayMode:function(t){this.options.displayMode=t,this._active&&this.update()},getPointById:function(t){for(var o=this.options.data,e=0;e<o.length;e++)if(t==o[e].properties.id)return o[e]},isActive:function(){return this._active},_getConnectionsDomain:function(t){var o=[];t.forEach(function(t){o=o.concat(Object.values(t.connections))});var e=d3.min(o),n=d3.max(o);return[e,n]},_drawConnections:function(t){var o=this,e=this._map,n=this.options.data,i=this._svgGroup2;i.selectAll(".connection").remove();var a=[],s=[];if(n.forEach(function(n){var r=Object.keys(n.connections);r.forEach(function(r){var l=o.getPointById(r);if(l&&n.connections[r]){var p="grey",c=.2,d=n.connections[r];if(t&&"LOCAL"===o.options.weightMode){if(t===n.properties.id){var u={properties:n.properties,connections:{}};return u.connections[r]=n.connections[r],void a.push(u)}if(t===r){var h={properties:n.properties,connections:{}};return h.connections[r]=n.connections[r],void s.push(h)}}else"GLOBAL"===o.options.weightMode?(p=o._globalColorScale(d),c=o.options.lineOpacity):t&&"NONE"===o.options.weightMode&&("SOURCE"==o.options.displayMode&&t==n.properties.id?(p=o.options.sourceColor,c=o.options.lineOpacity):"SINK"==o.options.displayMode&&t==r?(p=o.options.sinkColor,c=o.options.lineOpacity):"ANY"==o.options.displayMode?t!=n.properties.id&&t!=r||(p=o.options.allColor,c=o.options.lineOpacity):"BOTH"==o.options.displayMode&&(t==n.properties.id&&(p=o.options.sourceColor,c=o.options.lineOpacity),t==r&&(p=o.options.sinkColor,c=o.options.lineOpacity)));var g=e.latLngToLayerPoint(n.properties.LatLng),L=e.latLngToLayerPoint(l.properties.LatLng);"NONE"!==o.options.weightMode?i.append("line").attr("class","connection").attr("x1",g.x).attr("y1",g.y).attr("x2",L.x).attr("y2",L.y).attr("stroke-width",o.options.lineWidthActive).attr("stroke-opacity",c).attr("stroke",p).attr("data-weight",d).attr("data-lat",l.properties.LatLng.lat).attr("data-lon",l.properties.LatLng.lng).on("mouseenter",function(){o.options.onMouseEnterLine&&o.options.onMouseEnterLine(this)}).on("mouseleave",function(){o.options.onMouseLeaveLine&&o.options.onMouseLeaveLine(this)}):i.append("line").attr("class","connection").attr("x1",g.x).attr("y1",g.y).attr("x2",L.x).attr("y2",L.y).attr("stroke-width",2).attr("stroke-opacity",c).attr("stroke",p)}})}),"BOTH"===o.options.displayMode){var r=this._getConnectionsDomain(s),l=d3.scaleLinear().domain(r).interpolate(d3.interpolateRgb).range(o._colors);this._drawLocalWeightedNodes(s,l,i,o.options.lineDashStyle);var p=this._getConnectionsDomain(a),c=d3.scaleLinear().domain(p).interpolate(d3.interpolateRgb).range(o._colors);this._drawLocalWeightedNodes(a,c,i,null)}else{var d;switch(o.options.displayMode){case"SINK":d=s;break;case"SOURCE":d=a;break;case"ANY":d=s.concat(a);break;default:console.error("Invalid displayMode")}var u=this._getConnectionsDomain(d),h=d3.scaleLinear().domain(u).interpolate(d3.interpolateHcl).range(o._colors);this._drawLocalWeightedNodes(d,h,i,null)}},_drawLocalWeightedNodes:function(t,o,e,n){var i=this;t.forEach(function(t){var a=Object.keys(t.connections);a.forEach(function(a){var s=i.getPointById(a);if(s&&t.connections[a]){var r=t.connections[a],l=i._map.latLngToLayerPoint(t.properties.LatLng),p=i._map.latLngToLayerPoint(s.properties.LatLng);e.append("line").attr("class","connection").attr("x1",l.x).attr("y1",l.y).attr("x2",p.x).attr("y2",p.y).attr("stroke-width",i.options.lineWidthActive).attr("stroke-opacity",i.options.lineOpacity).attr("stroke",o(r)).attr("data-weight",r).attr("data-lat",s.properties.LatLng.lat).attr("data-lon",s.properties.LatLng.lng).style("cursor","pointer").style("stroke-dasharray",n).on("mouseenter",function(){i.options.onMouseEnterLine&&i.options.onMouseEnterLine(this)}).on("mouseleave",function(){i.options.onMouseLeaveLine&&i.options.onMouseLeaveLine(this)})}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};