"use strict";L.NetworkLayer=(L.Layer?L.Layer:L.Class).extend({options:{data:null,displayMode:"ANY",globalWeightMode:!0,localColorScale:["green","red"],sourceColor:"red",sinkColor:"green",allColor:"blue",scaleDomain:null,lineWidthRange:[1,5],nodeFillColor:"red",nodeOpacity:.5,nodeRadius:5,lineOpacity:.8,lineWidth:2,lineWidthActive:2,lineDashStyle:"20, 3",onClickNode:null,onMouseEnterNode:null,onMouseLeaveNode:null,onMouseEnterLine:null,onMouseLeaveLine:null},_active:!1,_map:null,_mapSvg:null,_svgGroup1:null,_svgGroup2:null,_targetId:null,_linearWidthScale:null,_localColors:[],initialize:function(t){L.setOptions(this,t)},onAdd:function(t){var o=this,e=this;this._active=!0;var n=this.options.data.map(function(t){return delete t.connections[t.properties.id],t});this._targetId=null;var i;i=this.options.scaleDomain?this.options.scaleDomain:this._getConnectionsDomain(n),this.options.localColorScale.forEach(function(t){o._localColors.push(d3.rgb(t))}),this._linearWidthScale=d3.scaleLinear().domain(i).range(this.options.lineWidthRange),this._mapSvg=L.svg(),this._mapSvg.addTo(t);var s=d3.select("#"+t.getContainer().id).select("svg");s.attr("pointer-events","all"),this._svgGroup1=s.append("g"),this._svgGroup2=this._svgGroup1.append("g"),n.forEach(function(t){t.properties.LatLng=new L.LatLng(t.properties.lat,t.properties.lon)}),this._svgGroup1.selectAll("circle").data(n.map(function(t){return t})).attr("class","site").enter().append("circle").style("opacity",e.options.nodeOpacity).style("cursor","pointer").style("fill",e.options.nodeFillColor).attr("r",e.options.nodeRadius).on("click",function(t){console.log(t),e._svgGroup1.selectAll("circle").style("opacity",e.options.nodeOpacity).attr("r",5),d3.select(this).style("opacity","1").attr("r",10),e._targetId=t.properties.id,e._drawConnections(e._targetId),e.options.onClickNode&&e.options.onClickNode(t)}).on("mouseenter",this.options.onMouseEnterNode).on("mouseleave",this.options.onMouseLeaveNode),this._map=t,this._map.on("moveend viewreset",this.update,this),this.update()},onRemove:function(t){this._active=!1,this._mapSvg.removeFrom(t)},update:function(){var t=this;t._drawConnections(this._targetId),this._targetId||t._svgGroup1.selectAll("circle").style("opacity",t.options.nodeOpacity).attr("r",t.options.nodeRadius),this._svgGroup1.selectAll("circle").attr("transform",function(o){return"translate("+t._map.latLngToLayerPoint(o.properties.LatLng).x+","+t._map.latLngToLayerPoint(o.properties.LatLng).y+")"})},setData:function(t){this.options.data=t,this._active&&this.update()},setOptions:function(t){L.setOptions(this,t),this._active&&this.update()},setTarget:function(t){this._targetId=t,this._active&&this.update()},getTargetId:function(){return this._targetId},setDisplayMode:function(t){this.options.displayMode=t,this._active&&this.update()},getPointById:function(t){for(var o=this.options.data,e=0;e<o.length;e++)if(t==o[e].properties.id)return o[e]},isActive:function(){return this._active},_getConnectionsDomain:function(t){var o=[];t.forEach(function(t){o=o.concat(Object.values(t.connections))});var e=d3.min(o),n=d3.max(o);return[e,n]},_drawConnections:function(t){var o=this,e=this._map,n=this.options.data,i=this._svgGroup2;i.selectAll(".connection").remove();var s=[],a=[];if(n.forEach(function(n){var r=Object.keys(n.connections);r.forEach(function(r){var l=o.getPointById(r);if(l&&n.connections[r]){var c="grey",p=.2;n.connections[r];if(t&&!o.options.globalWeightMode){if(t===n.properties.id){var d={properties:n.properties,connections:{}};return d.connections[r]=n.connections[r],void s.push(d)}if(t===r){var u={properties:n.properties,connections:{}};return u.connections[r]=n.connections[r],void a.push(u)}}else t&&o.options.globalWeightMode&&("SOURCE"==o.options.displayMode&&t==n.properties.id?(c=o.options.sourceColor,p=o.options.lineOpacity):"SINK"==o.options.displayMode&&t==r?(c=o.options.sinkColor,p=o.options.lineOpacity):"ANY"==o.options.displayMode?t!=n.properties.id&&t!=r||(c=o.options.allColor,p=o.options.lineOpacity):"BOTH"==o.options.displayMode&&(t==n.properties.id&&(c=o.options.sourceColor,p=o.options.lineOpacity),t==r&&(c=o.options.sinkColor,p=o.options.lineOpacity)));var h=e.latLngToLayerPoint(n.properties.LatLng),g=e.latLngToLayerPoint(l.properties.LatLng);i.append("line").attr("class","connection").attr("x1",h.x).attr("y1",h.y).attr("x2",g.x).attr("y2",g.y).attr("stroke-width",.2===p?o.options.lineWidth:o.options.lineWidthActive).attr("stroke-opacity",p).attr("stroke",c)}})}),"BOTH"===o.options.displayMode){var r=this._getConnectionsDomain(a),l=d3.scaleLinear().domain(r).interpolate(d3.interpolateHcl).range(o._localColors);this._drawLocalWeightedNodes(a,l,i,o.options.lineDashStyle);var c=this._getConnectionsDomain(s),p=d3.scaleLinear().domain(c).interpolate(d3.interpolateHcl).range(o._localColors);this._drawLocalWeightedNodes(s,p,i,null)}else{var d;switch(o.options.displayMode){case"SINK":d=a;break;case"SOURCE":d=s;break;case"ANY":d=a.concat(s);break;default:console.error("Invalid displayMode")}var u=this._getConnectionsDomain(d),h=d3.scaleLinear().domain(u).interpolate(d3.interpolateHcl).range(o._localColors);this._drawLocalWeightedNodes(d,h,i,null)}},_drawLocalWeightedNodes:function(t,o,e,n){var i=this;t.forEach(function(t){var s=Object.keys(t.connections);s.forEach(function(s){var a=i.getPointById(s);if(a&&t.connections[s]){var r=t.connections[s],l=i._map.latLngToLayerPoint(t.properties.LatLng),c=i._map.latLngToLayerPoint(a.properties.LatLng);e.append("line").attr("class","connection").attr("x1",l.x).attr("y1",l.y).attr("x2",c.x).attr("y2",c.y).attr("stroke-width",i.options.lineWidthActive).attr("stroke-opacity",i.options.lineOpacity).attr("stroke",o(r)).attr("data-weight",r).style("cursor","pointer").style("stroke-dasharray",n).on("mouseenter",function(){i.options.onMouseEnterLine&&i.options.onMouseEnterLine(this,this.dataset.weight)}).on("mouseleave",function(){i.options.onMouseLeaveLine&&i.options.onMouseLeaveLine(this,this.dataset.weight)})}})})}}),L.networkLayer=function(t){return new L.NetworkLayer(t)};